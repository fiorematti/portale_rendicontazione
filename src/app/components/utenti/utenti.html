<div class="container-fluid min-vh-100 p-2">
  <h1 class="page-title mb-4">Utenti</h1>

  <div class="card card-custom mb-4 border-0 shadow-sm filter-container">
    <div class="card-body p-3">
      <div class="row g-3 align-items-end">
        
        <div class="col-12 col-md-4 col-lg-3">
          <label class="label-custom">Cerca utente</label>
          <div class="input-group custom-input-bg">
            <span class="input-group-text border-0 bg-transparent">
              <i class="bi bi-search"></i>
            </span>
            <input type="text" 
                   [(ngModel)]="filtroTesto"
                   class="form-control border-0 bg-transparent shadow-none" 
                   placeholder="Cerca utente...">
          </div>
        </div>
        
        <div class="col-6 col-md-3 col-lg-2">
          <label class="label-custom">Ruolo</label>
          <select [(ngModel)]="filtroRuolo" class="form-select border-0 custom-input-bg shadow-none">
            <option value="">Tutti i ruoli</option>
            <option value="Admin">Admin</option>
            <option value="Utente interno">Utente interno</option>
            <option value="Utente esterno">Utente esterno</option>
          </select>
        </div>

        <div class="col-6 col-md-3 col-lg-2">
          <label class="label-custom">Stato</label>
          <select [(ngModel)]="filtroStato" class="form-select border-0 custom-input-bg shadow-none">
            <option value="">Tutti gli stati</option>
            <option value="attivo">Attivo</option>
            <option value="non-attivo">Non attivo</option>
          </select>
        </div>

        <div class="col-12 col-md-2 col-lg-5 text-md-end">
          <button class="btn btn-dark-custom px-4 w-100-mobile" (click)="openModal()">
            <i class="bi bi-plus-lg me-2"></i>Aggiungi Utente
          </button>
        </div>

      </div>
    </div>
  </div>

  <div class="card card-custom border-0 shadow-sm overflow-hidden">
    <div class="table-responsive">
      <table class="table align-middle mb-0">
        <thead>
          <tr>
            <th class="ps-4">Nome</th>
            <th>Cognome</th>
            <th>Ruolo</th>
            <th>Stato</th>
            <th class="pe-4 text-end">Azioni</th>
          </tr>
        </thead>
        <tbody>
          @for (utente of utentiFiltrati; track utente.email) {
            <tr>
              <td class="ps-4 fw-medium text-nowrap">{{ utente.nome }}</td>
              <td class="text-muted text-nowrap">{{ utente.cognome }}</td>
              <td class="text-muted text-nowrap">{{ utente.ruolo }}</td>
              <td>
                <span class="badge-status" 
                      [class.badge-attivo]="utente.attivo" 
                      [class.badge-non-attivo]="!utente.attivo">
                  {{ utente.attivo ? 'attivo' : 'non attivo' }}
                </span>
              </td>
              <td class="pe-4 text-end text-nowrap">
                <button class="btn-action" (click)="openDettaglio(utente)">
                  <i class="bi bi-eye"></i>
                </button>
                
                <button class="btn-action mx-3" (click)="eliminaUtente(utentiOriginali.indexOf(utente))">
                  <i class="bi bi-trash3"></i>
                </button>

                <button class="btn-action" (click)="openModal(utente, utentiOriginali.indexOf(utente))">
                  <i class="bi bi-pencil"></i>
                </button>
              </td>
            </tr>
          } @empty {
            <tr>
              <td colspan="5" class="text-center py-5 text-muted">
                Nessun utente trovato con i filtri selezionati.
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  </div>
</div>

@if (isModalOpen) {
  <div class="modal-overlay">
    <div class="modal-card">
      <h2 class="modal-title">{{ isEditMode ? 'Modifica Utente' : 'Aggiungi Utente' }}</h2>

      @if (mostraErrore) {
        <div class="alert alert-danger border-0 shadow-sm d-flex align-items-center mb-4" role="alert" style="border-radius: 15px;">
          <i class="bi bi-exclamation-circle-fill me-2 fs-5"></i>
          <div>Tutti i campi sono obbligatori per confermare.</div>
        </div>
      }

      <form #utenteForm="ngForm">
        <div class="row g-3 mt-2">
          <div class="col-md-6 text-start">
            <label class="label-custom">Nome</label>
            <input type="text" name="nome" [(ngModel)]="nuovoUtente.nome" 
                   class="form-control custom-input-bg" placeholder="Inserisci nome">
          </div>
          <div class="col-md-6 text-start">
            <label class="label-custom">Cognome</label>
            <input type="text" name="cognome" [(ngModel)]="nuovoUtente.cognome" 
                   class="form-control custom-input-bg" placeholder="Inserisci cognome">
          </div>
          <div class="col-md-6 text-start">
            <label class="label-custom">Email</label>
            <input type="email" name="email" [(ngModel)]="nuovoUtente.email" 
                   class="form-control custom-input-bg" placeholder="Inserisci email">
          </div>
          <div class="col-md-6 text-start">
            <label class="label-custom">Ruolo</label>
            <select name="ruolo" [(ngModel)]="nuovoUtente.ruolo" 
                    class="form-select custom-input-bg">
              <option value="" disabled selected>Scegli un ruolo</option>
              <option value="Admin">Admin</option>
              <option value="Utente interno">Utente interno</option>
              <option value="Utente esterno">Utente esterno</option>
            </select>
          </div>

          @if (isEditMode) {
            <div class="col-md-12 text-start">
              <label class="label-custom">Stato</label>
              <select name="attivo" [(ngModel)]="nuovoUtente.attivo" 
                      class="form-select custom-input-bg">
                <option [ngValue]="true">Attivo</option>
                <option [ngValue]="false">Non attivo</option>
              </select>
            </div>
          }
        </div>

        <div class="d-flex justify-content-center gap-3 mt-5">
          <button type="button" class="btn btn-cancel" (click)="closeModal()">Annulla</button>
          <button type="button" class="btn btn-confirm" (click)="salvaUtente()">
            Conferma
          </button>
        </div>
      </form>
    </div>
  </div>
}

@if (isDettaglioOpen) {
  <div class="modal-overlay">
    <div class="modal-card">
      <h2 class="modal-title">Dettaglio Utente</h2>
      <div class="row g-4 mt-2 text-start">
        <div class="col-md-6">
          <label class="label-custom d-block text-muted" style="font-size: 0.8rem;">NOME</label>
          <span class="fw-bold fs-5">{{ utenteDettaglio.nome }}</span>
        </div>
        <div class="col-md-6">
          <label class="label-custom d-block text-muted" style="font-size: 0.8rem;">COGNOME</label>
          <span class="fw-bold fs-5">{{ utenteDettaglio.cognome }}</span>
        </div>
        <div class="col-md-6">
          <label class="label-custom d-block text-muted" style="font-size: 0.8rem;">EMAIL</label>
          <span class="fw-bold fs-5">{{ utenteDettaglio.email }}</span>
        </div>
        <div class="col-md-6">
          <label class="label-custom d-block text-muted" style="font-size: 0.8rem;">RUOLO</label>
          <span class="fw-bold fs-5">{{ utenteDettaglio.ruolo }}</span>
        </div>
        <div class="col-md-12">
          <label class="label-custom d-block text-muted" style="font-size: 0.8rem;">STATO</label>
          <span class="badge-status" 
                [class.badge-attivo]="utenteDettaglio.attivo" 
                [class.badge-non-attivo]="!utenteDettaglio.attivo">
            {{ utenteDettaglio.attivo ? 'Attivo' : 'Non Attivo' }}
          </span>
        </div>
      </div>
      <div class="d-flex justify-content-center gap-3 mt-5">
        <button type="button" class="btn btn-cancel" (click)="closeDettaglio()">Esci</button>
        <button type="button" class="btn btn-confirm" (click)="passaAModificaDaDettaglio()">
          Modifica
        </button>
      </div>
    </div>
  </div>
}